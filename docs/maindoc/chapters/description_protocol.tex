\chapter{Description of the protocol}
\section{Introduction}
   The protocol developed in this project has been designed to garantee secrecy, integrity and authentication. It is used by a simple client-server application wich allows clients to download files stored inside the server. \\
   The overall protocol is based on public encrypt. Infact we suppose that the client already has the public key of the server stored on
   its filesystem. The public encryption scheme allows to authenticate the server. It also allows to exchange a secret master key wich is used by symmetric ciphers to encrpyt the following communications. It is also used an HMAC to garantee integrity and nonces to garantee freshness of communications.
\section{Description}
\begin{sequencediagram}
	\def\unitfactor{1}
	\newinst[0]{cl}{:Client}
	\newinst[11]{sr}{:Server}
	\mess{cl}{\small1) ClientHello,ClientNonce}{sr}
	\mess{sr}{\small2) ServerHello,ServerNonce}{cl}
	\mess{sr}{\small3) \(\lbrace\)ClientNonce,ServerNonce\(\rbrace\)\textsubscript{K\textsubscript{priv}}}{cl}
	\mess{cl}{\small4) \(\lbrace\)ServerNonce,K\textsubscript{sess},Username,Password\(\rbrace\)\textsubscript{K\textsubscript{publ}}}{sr}
	\mess{sr}{\small5) Authentication OK}{cl}
	\mess{cl}{\small6) \(\lbrace\)Command,ServerNonce+1\(\rbrace\)\textsubscript{K\textsubscript{sess}}, HMAC\textsubscript{K\textsubscript{sess}}(Command,ServerNonce+1)}{sr}
	\mess{sr}{\small7) \(\lbrace\)Response,ClientNonce+1\(\rbrace\)\textsubscript{K\textsubscript{sess}},HMAC\textsubscript{K\textsubscript{sess}}(Response,ClientNonce+1)}{cl}
\end{sequencediagram}

\section{BAN Logic}
\newcommand{\believes}{\mid\equiv}
\newcommand{\sees}{\triangleleft}
\newcommand{\oncesaid}{\mid\sim}
\newcommand{\controls}{\Rightarrow}
\newcommand{\fresh}[1]{\#(#1)}
\newcommand{\combine}[2]{{\langle #1 \rangle}_{#2}}
\newcommand{\encrypt}[2]{{ \{ #1 \} }_{#2}}
\newcommand{\sharekey}[1]{\xleftrightarrow{#1}}
\newcommand{\pubkey}[1]{\xmapsto{#1}}
\newcommand{\secret}[1]{\xleftrightharpoons{#1}}

\[A \believes B \]
\[A \sees B \]
\[A \oncesaid B \]
\[A \controls B \]
\[\fresh{X}\]
\[\combine{X}{Y}\]
\[\encrypt{X}{Y}\]
\[A \sharekey{k} B \]
\[\pubkey{k} B\]
\[A \secret{k} B\]

\paragraph{Ipothesis}
\[\textnormal{Client} \believes \fresh{n_c}\]
\[\textnormal{Server} \believes \fresh{n_s}\]
\[\textnormal{Server} \controls n_s\]
\[\textnormal{Client} \controls n_c\]
\[\textnormal{Client} \believes \pubkey{K\textsubscript{publ}} \textnormal{Server}\]
\[\textnormal{Server} \believes \textnormal{Client} \controls K_{session}\]
\[\textnormal{Server} \believes \textnormal{Client} \sharekey{password} \textnormal{Server}\]

\paragraph{Objectives}
\[\textnormal{Client} \believes \textnormal{Client} \sharekey{K\textsubscript{sess }} \textnormal{Server}\]
\[\textnormal{Server} \believes \textnormal{Client} \sharekey{K\textsubscript{sess }} \textnormal{Server}\]
\[\textnormal{Client} \believes \textnormal{Server} \believes \textnormal{Client} \sharekey{K\textsubscript{sess }} \textnormal{Server}\]
\[\textnormal{Server} \believes \textnormal{Client} \believes \textnormal{Client} \sharekey{K\textsubscript{sess }} \textnormal{Server}\]
\[\textnormal{Client} \believes \fresh{\textnormal{Client} \sharekey{K\textsubscript{sess }} \textnormal{Server}}\]
\[\textnormal{Server} \believes \fresh{\textnormal{Client} \sharekey{K\textsubscript{sess }} \textnormal{Server}}\]

\paragraph{Idealized Protocol}
\[\textnormal{M3: Server} \rightarrow \textnormal{Client} \lbrace n_c,n_s \rbrace \textsubscript{priv} \]
\[\textnormal{M4: Client} \rightarrow \textnormal{Server} \lbrace n_s,K\textsubscript{sess},Username,Password \rbrace \textsubscript{publ}\]
\[\textnormal{M6: Client} \rightarrow \textnormal{Server} \lbrace CMD,n\textsubscript{s+1} \rbrace \textsubscript{K\textsubscript{sees}}\]
\[\textnormal{M7: Server} \rightarrow \textnormal{Client} \lbrace RESP,n\textsubscript{c+1} \rbrace \textsubscript{K\textsubscript{sess}}\]
